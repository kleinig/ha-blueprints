blueprint:
  name: PV Smart Load (Per Device - Switch & Climate)
  description: >
    One automation per device. Uses PV excess, forecast, and respects
    higher priority loads. Supports switch and climate devices.

  domain: automation

  input:
    target_device:
      name: Device (Switch or Climate)
      description: Select a switch or climate entity to control
      selector:
        entity: {}

    device_power:
      name: Device Power (W)
      selector:
        number:
          min: 0
          max: 10000

    higher_priority_devices:
      name: Higher Priority Devices
      description: Devices that must run before this one
      default: []
      selector:
        entity:
          multiple: true

    pv_power:
      name: PV Power
      selector:
        entity:
          domain: sensor

    house_load:
      name: House Load
      selector:
        entity:
          domain: sensor

    battery_soc:
      name: Battery SOC
      selector:
        entity:
          domain: sensor

    battery_target:
      name: Target Battery %
      default: 90
      selector:
        number:
          min: 0
          max: 100

    solcast_forecast_remaining:
      name: Remaining Forecast (kWh)
      selector:
        entity:
          domain: sensor

    battery_capacity_kwh:
      name: Battery Capacity (kWh)
      selector:
        number:
          min: 1
          max: 100

    min_runtime:
      name: Minimum Runtime (seconds)
      default: 0
      selector:
        number:
          min: 0
          max: 7200

    check_interval:
      name: Check Interval (minutes)
      default: 1
      selector:
        number:
          min: 1
          max: 10

mode: restart

trigger:
  - platform: time_pattern
    minutes: "/1"

variables:
  device: !input target_device
  device_domain: "{{ device.split('.')[0] }}"
  device_power: !input device_power

  pv: "{{ states(input.pv_power) | float(0) }}"
  load: "{{ states(input.house_load) | float(0) }}"
  soc: "{{ states(input.battery_soc) | float(0) }}"
  forecast: "{{ states(input.solcast_forecast_remaining) | float(0) }}"
  target: "{{ input.battery_target | float }}"
  capacity: "{{ input.battery_capacity_kwh | float }}"

  excess_power: "{{ pv - load }}"

  required_energy: >
    {{ ((target - soc) / 100) * capacity }}

  forecast_surplus: >
    {{ forecast - required_energy }}

  higher_running: >
    {{ expand(input.higher_priority_devices)
       | selectattr('state', 'ne', 'off')
       | list
       | count > 0 }}

  last_changed: "{{ states.get(device).last_changed }}"
  runtime: "{{ (now() - last_changed).total_seconds() }}"

action:

  # ðŸ”’ Safety: only allow switch or climate
  - condition: template
    value_template: >
      {{ device.split('.')[0] in ['switch', 'climate'] }}

  # â± Interval control
  - condition: template
    value_template: >
      {{ (now().minute % (input.check_interval | int)) == 0 }}

  - choose:

      # âœ… TURN ON
      - conditions:
          - condition: template
            value_template: >
              {{ excess_power > device_power
                 and forecast_surplus > 0
                 and not higher_running }}

          - condition: template
            value_template: >
              {{ states(device) == 'off' }}

        sequence:
          - service: >
              {% if device_domain == 'climate' %}
                climate.turn_on
              {% else %}
                switch.turn_on
              {% endif %}
            target:
              entity_id: "{{ device }}"

          - service: logbook.log
            data:
              name: PV Device Controller
              message: >
                ON {{ device }}
                | Excess: {{ excess_power | round(0) }}W
                | Forecast OK ({{ forecast_surplus | round(2) }}kWh)
                | No higher priority loads

      # âŒ TURN OFF
      - conditions:
          - condition: template
            value_template: >
              {{ excess_power < device_power
                 or forecast_surplus < 0
                 or higher_running }}

          - condition: template
            value_template: >
              {{ states(device) != 'off' }}

          - condition: template
            value_template: >
              {{ runtime > min_runtime }}

        sequence:
          - service: >
              {% if device_domain == 'climate' %}
                climate.turn_off
              {% else %}
                switch.turn_off
              {% endif %}
            target:
              entity_id: "{{ device }}"

          - service: logbook.log
            data:
              name: PV Device Controller
              message: >
                OFF {{ device }}
                | Reason:
                {% if higher_running %}Higher priority active {% endif %}
                {% if forecast_surplus < 0 %}Low forecast {% endif %}
                {% if excess_power < device_power %}Low solar {% endif %}
                | Runtime: {{ runtime | round(0) }}s
