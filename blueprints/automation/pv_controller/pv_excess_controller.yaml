blueprint:
  name: PV Smart Load Controller (Advanced - Forecast + Smoothing + Priority)
  description: >
    Advanced PV load controller with smoothing, hysteresis, battery protection,
    forecast awareness, and intelligent load prioritisation.
  domain: automation

  input:
    pv_power:
      selector:
        entity:
          domain: sensor

    house_load:
      selector:
        entity:
          domain: sensor

    battery_soc:
      selector:
        entity:
          domain: sensor

    battery_target:
      default: 90
      selector:
        number:
          min: 0
          max: 100

    solcast_forecast_remaining:
      selector:
        entity:
          domain: sensor

    battery_capacity_kwh:
      selector:
        number:
          min: 1
          max: 100

    loads:
      description: entity, power, priority, min_runtime
      selector:
        object:

    min_excess_power:
      default: 300
      selector:
        number:
          min: 0
          max: 10000

    hysteresis:
      name: Hysteresis Buffer (W)
      default: 200
      selector:
        number:
          min: 0
          max: 2000

    smoothing_factor:
      name: Smoothing Factor (0-1)
      description: Lower = smoother (recommended 0.3)
      default: 0.3
      selector:
        number:
          min: 0.1
          max: 1
          step: 0.1

    dump_mode_hour:
      name: Dump Mode Start Hour
      default: 15
      selector:
        number:
          min: 12
          max: 20

    check_interval:
      default: 1
      selector:
        number:
          min: 1
          max: 10

mode: restart

trigger:
  - platform: time_pattern
    minutes: "/1"

variables:
  pv: "{{ states(input.pv_power) | float(0) }}"
  load: "{{ states(input.house_load) | float(0) }}"
  soc: "{{ states(input.battery_soc) | float(0) }}"
  forecast: "{{ states(input.solcast_forecast_remaining) | float(0) }}"
  target: "{{ input.battery_target | float }}"
  capacity: "{{ input.battery_capacity_kwh | float }}"

  raw_excess: "{{ pv - load }}"

  # EMA smoothing (stores last value in input_number helper recommended)
  smoothed_excess: >
    {% set prev = states('input_number.pv_smoothed_excess') | float(0) %}
    {% set alpha = input.smoothing_factor | float %}
    {{ (alpha * raw_excess) + ((1 - alpha) * prev) }}

  required_energy: >
    {{ ((target - soc) / 100) * capacity }}

  forecast_surplus: >
    {{ forecast - required_energy }}

  dump_mode: >
    {{ now().hour >= (input.dump_mode_hour | int)
       and forecast_surplus > 0 }}

action:

  # â± Interval control
  - condition: template
    value_template: >
      {{ (now().minute % (input.check_interval | int)) == 0 }}

  # ðŸ’¾ Store smoothed value
  - service: input_number.set_value
    target:
      entity_id: input_number.pv_smoothed_excess
    data:
      value: "{{ smoothed_excess }}"

  - variables:
      sorted_loads: >
        {{ dict(input.loads)
           | dictsort(by='value.priority')
           | map(attribute=1)
           | list }}

  - repeat:
      for_each: "{{ sorted_loads }}"
      sequence:

        - variables:
            entity: "{{ repeat.item.entity }}"
            power: "{{ repeat.item.power }}"
            priority: "{{ repeat.item.priority }}"
            min_runtime: "{{ repeat.item.min_runtime | default(0) }}"
            last_changed: "{{ states.get(entity).last_changed }}"
            runtime: >
              {{ (now() - last_changed).total_seconds() }}

        - choose:

            # âœ… TURN ON (smoothed + hysteresis)
            - conditions:
                - condition: template
                  value_template: >
                    {{ smoothed_excess > (power + input.hysteresis)
                       and (forecast_surplus > 0 or dump_mode) }}

                - condition: template
                  value_template: >
                    {{ is_state(entity, 'off') }}

              sequence:
                - service: switch.turn_on
                  target:
                    entity_id: "{{ entity }}"

                - service: logbook.log
                  data:
                    name: PV Smart Controller
                    message: >
                      ON {{ entity }}
                      | Smoothed Excess: {{ smoothed_excess | round(0) }}W
                      | Forecast: {{ forecast_surplus | round(2) }}kWh
                      | Dump Mode: {{ dump_mode }}
                      | Priority: {{ priority }}

            # âŒ TURN OFF (hysteresis lower bound)
            - conditions:
                - condition: template
                  value_template: >
                    {{ smoothed_excess < (power - input.hysteresis)
                       and not dump_mode }}

                - condition: template
                  value_template: >
                    {{ is_state(entity, 'on') }}

                - condition: template
                  value_template: >
                    {{ runtime > min_runtime }}

              sequence:
                - service: switch.turn_off
                  target:
                    entity_id: "{{ entity }}"

                - service: logbook.log
                  data:
                    name: PV Smart Controller
                    message: >
                      OFF {{ entity }}
                      | Smoothed Excess: {{ smoothed_excess | round(0) }}W
                      | Runtime: {{ runtime | round(0) }}s
                      | Reason: Low solar or battery priority
